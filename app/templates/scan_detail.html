{% extends "base.html" %}

{% block title %}Scan Details - {{ scan.target }} - KAST Web{% endblock %}

{% block content %}
<script>
// Auto-refresh scan status when scan is running
let pollInterval = null;
const scanId = parseInt('{{ scan.id }}');
const currentStatus = '{{ scan.status }}';

function updateScanStatus() {
    fetch(`/api/scans/${scanId}/status`)
        .then(response => response.json())
        .then(data => {
            // Update status badge
            const statusBadge = document.getElementById('scan-status');
            if (statusBadge) {
                let badgeClass = 'bg-secondary';
                if (data.status === 'completed') {
                    badgeClass = 'bg-success';
                    stopPolling();
                } else if (data.status === 'running') {
                    badgeClass = 'bg-primary';
                } else if (data.status === 'failed') {
                    badgeClass = 'bg-danger';
                    stopPolling();
                }
                statusBadge.className = `badge ${badgeClass}`;
                statusBadge.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
            }
            
            // Update completed time
            if (data.completed_at) {
                const completedElem = document.getElementById('completed-at');
                if (completedElem) {
                    const date = new Date(data.completed_at);
                    completedElem.textContent = date.toLocaleString();
                }
            }
            
            // Update duration
            if (data.duration) {
                const durationElem = document.getElementById('duration');
                if (durationElem) {
                    durationElem.textContent = formatDuration(data.duration);
                }
            }
            
            // Update plugin results
            if (data.results && data.results.length > 0) {
                updatePluginResults(data.results);
            }
            
            // If scan completed or failed, reload page to show all elements
            if (data.status === 'completed' || data.status === 'failed') {
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        })
        .catch(error => {
            console.error('Error polling scan status:', error);
        });
}

function updatePluginResults(results) {
    const tbody = document.getElementById('plugin-results-tbody');
    const resultsSection = document.getElementById('plugin-results-section');
    
    if (!tbody) {
        // Show results section if it exists
        if (resultsSection) {
            resultsSection.style.display = 'block';
        }
        return;
    }
    
    // Show results section
    if (resultsSection) {
        resultsSection.style.display = 'block';
    }
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    // Add new rows
    results.forEach(result => {
        const row = document.createElement('tr');
        
        let statusBadge = 'bg-secondary';
        let statusText = 'Pending';
        
        if (result.status === 'completed') {
            statusBadge = 'bg-success';
            statusText = 'Completed';
        } else if (result.status === 'in_progress') {
            statusBadge = 'bg-primary';
            statusText = 'In Progress';
        } else if (result.status === 'pending') {
            statusBadge = 'bg-secondary';
            statusText = 'Pending';
        } else if (result.status === 'success') {
            statusBadge = 'bg-success';
            statusText = 'Success';
        } else if (result.status === 'fail') {
            statusBadge = 'bg-danger';
            statusText = 'Failed';
        }
        
        const executedTime = result.executed_at ? new Date(result.executed_at).toLocaleTimeString() : 'N/A';
        
        row.innerHTML = `
            <td><strong>${result.plugin_name}</strong></td>
            <td><span class="badge ${statusBadge}">${statusText}</span></td>
            <td>${result.findings_count > 0 ? `<span class="badge bg-info">${result.findings_count}</span>` : '<span class="text-muted">0</span>'}</td>
            <td><small>${executedTime}</small></td>
        `;
        
        tbody.appendChild(row);
    });
}

function formatDuration(seconds) {
    if (!seconds) return 'N/A';
    
    if (seconds < 60) {
        return `${Math.floor(seconds)}s`;
    } else if (seconds < 3600) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}m ${secs}s`;
    } else {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${minutes}m`;
    }
}

function startPolling() {
    // Poll every 3 seconds
    pollInterval = setInterval(updateScanStatus, 3000);
    // Do an immediate update
    updateScanStatus();
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

// Start polling if scan is running or pending
if (currentStatus === 'running' || currentStatus === 'pending') {
    startPolling();
}

// Stop polling when page is unloaded
window.addEventListener('beforeunload', stopPolling);
</script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-file-earmark-text"></i> Scan Details</h2>
    <div>
        <a href="{{ url_for('scans.list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to List
        </a>
    </div>
</div>

<div class="row">
    <!-- Scan Information -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Scan Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Scan ID:</strong> {{ scan.id }}
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        {% if scan.status == 'completed' %}
                            <span id="scan-status" class="badge bg-success">Completed</span>
                        {% elif scan.status == 'running' %}
                            <span id="scan-status" class="badge bg-primary">Running</span>
                        {% elif scan.status == 'failed' %}
                            <span id="scan-status" class="badge bg-danger">Failed</span>
                        {% else %}
                            <span id="scan-status" class="badge bg-secondary">{{ scan.status }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Target:</strong> <code>{{ scan.target }}</code>
                    </div>
                    <div class="col-md-6">
                        <strong>Scan Mode:</strong>
                        <span class="badge bg-{% if scan.scan_mode == 'active' %}warning{% else %}info{% endif %}">
                            {{ scan.scan_mode }}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Started:</strong> {{ scan.started_at.strftime('%Y-%m-%d %H:%M:%S') }}
                    </div>
                    <div class="col-md-6">
                        <strong>Completed:</strong>
                        <span id="completed-at">
                        {% if scan.completed_at %}
                            {{ scan.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% else %}
                            <span class="text-muted">N/A</span>
                        {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Duration:</strong> <span id="duration">{{ format_duration(scan.duration) }}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Parallel Execution:</strong>
                        {% if scan.parallel %}
                            <i class="bi bi-check-circle text-success"></i> Yes
                        {% else %}
                            <i class="bi bi-x-circle text-muted"></i> No
                        {% endif %}
                    </div>
                </div>
                
                {% if scan.plugins %}
                    <div class="mb-3">
                        <strong>Plugins:</strong>
                        <div class="mt-2">
                            {% for plugin in scan.plugin_list %}
                                <span class="badge bg-secondary me-1">{{ plugin }}</span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                {% if scan.output_dir %}
                    <div class="mb-3">
                        <strong>Output Directory:</strong>
                        <code class="d-block mt-1">{{ scan.output_dir }}</code>
                    </div>
                {% endif %}
                
                {% if scan.error_message %}
                    <div class="alert alert-danger mb-0">
                        <strong><i class="bi bi-exclamation-triangle"></i> Error:</strong>
                        <pre class="mb-0 mt-2">{{ scan.error_message }}</pre>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Plugin Results -->
        <div id="plugin-results-section" class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-puzzle"></i> Plugin Results</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Plugin</th>
                                <th>Status</th>
                                <th>Findings</th>
                                <th>Executed</th>
                            </tr>
                        </thead>
                        <tbody id="plugin-results-tbody">
                            {% for result in results %}
                                <tr>
                                    <td><strong>{{ result.plugin_name if result is mapping else result['plugin_name'] }}</strong></td>
                                    <td>
                                        {% set status = result.status if result is mapping else result['status'] %}
                                        {% if status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif status == 'in_progress' %}
                                            <span class="badge bg-primary">In Progress</span>
                                        {% elif status == 'pending' %}
                                            <span class="badge bg-secondary">Pending</span>
                                        {% elif status == 'success' %}
                                            <span class="badge bg-success">Success</span>
                                        {% elif status == 'fail' %}
                                            <span class="badge bg-danger">Failed</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set findings = result.findings_count if result is mapping else result['findings_count'] %}
                                        {% if findings > 0 %}
                                            <span class="badge bg-info">{{ findings }}</span>
                                        {% else %}
                                            <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set executed = result.executed_at if result is mapping else result['executed_at'] %}
                                        <small>{{ executed.strftime('%H:%M:%S') if executed else 'N/A' }}</small>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Sidebar -->
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Actions</h5>
            </div>
            <div class="card-body">
                {% if scan.status == 'completed' and report_path %}
                    <a href="{{ url_for('scans.view_report', scan_id=scan.id) }}" 
                       class="btn btn-success w-100 mb-2">
                        <i class="bi bi-file-earmark-text"></i> View Report
                    </a>
                    <div class="btn-group w-100 mb-2" role="group">
                        <a href="{{ url_for('scans.download_report', scan_id=scan.id, format='pdf') }}" 
                           class="btn btn-outline-success">
                            <i class="bi bi-download"></i> Download Report (PDF)
                        </a>
                        <button type="button" class="btn btn-outline-success dropdown-toggle dropdown-toggle-split" 
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('scans.download_report', scan_id=scan.id, format='pdf') }}">
                                    <i class="bi bi-file-earmark-pdf"></i> PDF Report
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('scans.download_report', scan_id=scan.id, format='html') }}">
                                    <i class="bi bi-file-earmark-text"></i> HTML Report
                                </a>
                            </li>
                        </ul>
                    </div>
                    <hr>
                {% endif %}
                
                {% if scan.output_dir %}
                    <a href="{{ url_for('scans.list_files', scan_id=scan.id) }}" 
                       target="_blank"
                       class="btn btn-outline-primary w-100 mb-2">
                        <i class="bi bi-folder2-open"></i> View Output Files
                    </a>
                {% endif %}
                
                <!-- Share Button (Owner/Admin only) -->
                {% if current_user.is_admin or scan.user_id == current_user.id %}
                    <button type="button" class="btn btn-outline-info w-100 mb-2" 
                            data-bs-toggle="modal" data-bs-target="#shareModal">
                        <i class="bi bi-share"></i> Share Scan
                    </button>
                {% endif %}
                
                <hr>
                
                {% if scan.status == 'completed' and scan.output_dir %}
                    <form method="POST" action="{{ url_for('scans.regenerate_report', scan_id=scan.id) }}" 
                          onsubmit="return confirm('Regenerate the PDF/HTML report for this scan?');">
                        <button type="submit" class="btn btn-warning w-100 mb-2">
                            <i class="bi bi-arrow-repeat"></i> Regenerate Report
                        </button>
                    </form>
                {% endif %}
                
                <form method="POST" action="{{ url_for('scans.rerun', scan_id=scan.id) }}" 
                      onsubmit="return confirm('Re-run this scan with the same configuration?');">
                    <button type="submit" class="btn btn-info w-100 mb-2">
                        <i class="bi bi-arrow-clockwise"></i> Re-run Scan
                    </button>
                </form>
                
                <form method="POST" action="{{ url_for('scans.delete', scan_id=scan.id) }}" 
                      onsubmit="return confirm('Are you sure you want to delete this scan? This action cannot be undone.');">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-trash"></i> Delete Scan
                    </button>
                </form>
            </div>
        </div>

        <!-- Configuration -->
        <div class="card shadow">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-sliders"></i> Configuration</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0 small">
                    <li class="mb-2">
                        <strong>Verbose:</strong>
                        {% if scan.verbose %}
                            <i class="bi bi-check-circle text-success"></i> Enabled
                        {% else %}
                            <i class="bi bi-x-circle text-muted"></i> Disabled
                        {% endif %}
                    </li>
                    <li class="mb-2">
                        <strong>Dry Run:</strong>
                        {% if scan.dry_run %}
                            <i class="bi bi-check-circle text-success"></i> Yes
                        {% else %}
                            <i class="bi bi-x-circle text-muted"></i> No
                        {% endif %}
                    </li>
                    <li>
                        <strong>Parallel:</strong>
                        {% if scan.parallel %}
                            <i class="bi bi-check-circle text-success"></i> Yes
                        {% else %}
                            <i class="bi bi-x-circle text-muted"></i> No
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
{% if current_user.is_admin or scan.user_id == current_user.id %}
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="bi bi-share"></i> Share Scan: {{ scan.target }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="shareTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="share-user-tab" data-bs-toggle="tab" 
                                data-bs-target="#share-user" type="button" role="tab">
                            <i class="bi bi-person-plus"></i> Share with User
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="public-link-tab" data-bs-toggle="tab" 
                                data-bs-target="#public-link" type="button" role="tab">
                            <i class="bi bi-link-45deg"></i> Public Link
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="current-shares-tab" data-bs-toggle="tab" 
                                data-bs-target="#current-shares" type="button" role="tab"
                                onclick="loadShares()">
                            <i class="bi bi-list-ul"></i> Current Shares
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="shareTabContent">
                    <!-- Share with User Tab -->
                    <div class="tab-pane fade show active" id="share-user" role="tabpanel">
                        <form method="POST" action="{{ url_for('scans.share_with_user', scan_id=scan.id) }}">
                            <div class="mb-3">
                                <label for="user_id" class="form-label">Select User</label>
                                <select class="form-select" id="user_id" name="user_id" required>
                                    <option value="">Choose a user...</option>
                                    {% for user in [] %}{% endfor %}
                                </select>
                                <small class="form-text text-muted">Select a user to share this scan with</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="permission_level" class="form-label">Permission Level</label>
                                <select class="form-select" id="permission_level" name="permission_level" required>
                                    <option value="view">View Only - Can view scan details and reports</option>
                                    <option value="edit">Can Edit - Can also regenerate reports and re-run scans</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="expires_in_days" class="form-label">Expires in (days)</label>
                                <input type="number" class="form-control" id="expires_in_days" 
                                       name="expires_in_days" value="0" min="0" max="365">
                                <small class="form-text text-muted">0 = Never expires</small>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-share"></i> Share with User
                            </button>
                        </form>
                    </div>
                    
                    <!-- Public Link Tab -->
                    <div class="tab-pane fade" id="public-link" role="tabpanel">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Public links allow anyone with the link to view this scan without logging in. 
                            Links are view-only and will expire after the specified period.
                        </div>
                        
                        <form method="POST" action="{{ url_for('scans.generate_public_link', scan_id=scan.id) }}">
                            <div class="mb-3">
                                <label for="expires_in_days_public" class="form-label">Expires in (days)</label>
                                <input type="number" class="form-control" id="expires_in_days_public" 
                                       name="expires_in_days" value="7" min="1" max="365" required>
                                <small class="form-text text-muted">Public links must have an expiration date</small>
                            </div>
                            
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-link-45deg"></i> Generate Public Link
                            </button>
                        </form>
                        
                        <div id="public-link-display" class="mt-4" style="display: none;">
                            <div class="alert alert-success">
                                <strong>Public Link Generated!</strong>
                                <div class="input-group mt-2">
                                    <input type="text" class="form-control" id="public-link-url" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyPublicLink()">
                                        <i class="bi bi-clipboard"></i> Copy
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Shares Tab -->
                    <div class="tab-pane fade" id="current-shares" role="tabpanel">
                        <div id="shares-loading" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        
                        <div id="shares-list" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Shared With</th>
                                            <th>Permission</th>
                                            <th>Expires</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shares-tbody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="no-shares" class="alert alert-info" style="display: none;">
                                <i class="bi bi-info-circle"></i> No shares found for this scan.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function loadShares() {
    document.getElementById('shares-loading').style.display = 'block';
    document.getElementById('shares-list').style.display = 'none';
    
    fetch(`/scans/{{ scan.id }}/shares`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('shares-loading').style.display = 'none';
            document.getElementById('shares-list').style.display = 'block';
            
            const tbody = document.getElementById('shares-tbody');
            tbody.innerHTML = '';
            
            if (data.shares && data.shares.length > 0) {
                document.getElementById('no-shares').style.display = 'none';
                
                data.shares.forEach(share => {
                    const row = document.createElement('tr');
                    
                    const sharedWith = share.is_public ? 
                        '<span class="badge bg-success">Public Link</span>' : 
                        share.shared_with_username;
                    
                    const permission = share.permission_level === 'edit' ? 
                        '<span class="badge bg-warning">Edit</span>' : 
                        '<span class="badge bg-info">View</span>';
                    
                    const expires = share.expires_at ? 
                        new Date(share.expires_at).toLocaleDateString() : 
                        '<span class="text-muted">Never</span>';
                    
                    const expired = share.is_expired ? 
                        '<span class="badge bg-danger ms-1">Expired</span>' : '';
                    
                    row.innerHTML = `
                        <td>${sharedWith}</td>
                        <td>${permission}</td>
                        <td>${expires}${expired}</td>
                        <td>
                            <form method="POST" action="/scans/{{ scan.id }}/share/${share.id}/revoke" 
                                  style="display: inline;" 
                                  onsubmit="return confirm('Revoke this share?');">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-x-circle"></i> Revoke
                                </button>
                            </form>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } else {
                document.getElementById('no-shares').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading shares:', error);
            document.getElementById('shares-loading').style.display = 'none';
            alert('Error loading shares');
        });
}

function copyPublicLink() {
    const input = document.getElementById('public-link-url');
    input.select();
    document.execCommand('copy');
    alert('Link copied to clipboard!');
}

// Load users for sharing dropdown when modal opens
const scanOwnerId = parseInt('{{ scan.user_id }}');
document.getElementById('shareModal').addEventListener('show.bs.modal', function() {
    fetch('/api/users/active')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('user_id');
            // Clear existing options except first
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Add users
            if (data.users) {
                data.users.forEach(user => {
                    // Don't show scan owner
                    if (user.id !== scanOwnerId) {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username + ' (' + user.email + ')';
                        select.appendChild(option);
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
        });
});
</script>
{% endif %}

{% endblock %}
