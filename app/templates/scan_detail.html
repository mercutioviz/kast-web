{% extends "base.html" %}

{% block title %}Scan Details - {{ scan.target }} - KAST Web{% endblock %}

{% block content %}
<script>
// Auto-refresh scan status when scan is running
let pollInterval = null;
const scanId = parseInt('{{ scan.id }}');
const currentStatus = '{{ scan.status }}';

function updateScanStatus() {
    fetch(`/api/scans/${scanId}/status`)
        .then(response => response.json())
        .then(data => {
            // Update status badge
            const statusBadge = document.getElementById('scan-status');
            if (statusBadge) {
                let badgeClass = 'bg-secondary';
                if (data.status === 'completed') {
                    badgeClass = 'bg-success';
                    stopPolling();
                } else if (data.status === 'running') {
                    badgeClass = 'bg-primary';
                } else if (data.status === 'failed') {
                    badgeClass = 'bg-danger';
                    stopPolling();
                }
                statusBadge.className = `badge ${badgeClass}`;
                statusBadge.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
            }
            
            // Update completed time
            if (data.completed_at) {
                const completedElem = document.getElementById('completed-at');
                if (completedElem) {
                    const date = new Date(data.completed_at);
                    completedElem.textContent = date.toLocaleString();
                }
            }
            
            // Update duration
            if (data.duration) {
                const durationElem = document.getElementById('duration');
                if (durationElem) {
                    durationElem.textContent = formatDuration(data.duration);
                }
            }
            
            // Update plugin results
            if (data.results && data.results.length > 0) {
                updatePluginResults(data.results);
            }
            
            // If scan completed or failed, reload page to show all elements
            if (data.status === 'completed' || data.status === 'failed') {
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        })
        .catch(error => {
            console.error('Error polling scan status:', error);
        });
}

function updatePluginResults(results) {
    const tbody = document.getElementById('plugin-results-tbody');
    const resultsSection = document.getElementById('plugin-results-section');
    
    if (!tbody) {
        // Show results section if it exists
        if (resultsSection) {
            resultsSection.style.display = 'block';
        }
        return;
    }
    
    // Show results section
    if (resultsSection) {
        resultsSection.style.display = 'block';
    }
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    // Add new rows
    results.forEach(result => {
        const row = document.createElement('tr');
        
        let statusBadge = 'bg-secondary';
        let statusText = 'Pending';
        
        if (result.status === 'completed') {
            statusBadge = 'bg-success';
            statusText = 'Completed';
        } else if (result.status === 'in_progress') {
            statusBadge = 'bg-primary';
            statusText = 'In Progress';
        } else if (result.status === 'pending') {
            statusBadge = 'bg-secondary';
            statusText = 'Pending';
        } else if (result.status === 'success') {
            statusBadge = 'bg-success';
            statusText = 'Success';
        } else if (result.status === 'fail') {
            statusBadge = 'bg-danger';
            statusText = 'Failed';
        }
        
        const executedTime = result.executed_at ? new Date(result.executed_at).toLocaleTimeString() : 'N/A';
        
        row.innerHTML = `
            <td><strong>${result.plugin_name}</strong></td>
            <td><span class="badge ${statusBadge}">${statusText}</span></td>
            <td>${result.findings_count > 0 ? `<span class="badge bg-info">${result.findings_count}</span>` : '<span class="text-muted">0</span>'}</td>
            <td><small>${executedTime}</small></td>
        `;
        
        tbody.appendChild(row);
    });
}

function formatDuration(seconds) {
    if (!seconds) return 'N/A';
    
    if (seconds < 60) {
        return `${Math.floor(seconds)}s`;
    } else if (seconds < 3600) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}m ${secs}s`;
    } else {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${minutes}m`;
    }
}

function startPolling() {
    // Poll every 3 seconds
    pollInterval = setInterval(updateScanStatus, 3000);
    // Do an immediate update
    updateScanStatus();
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

// Start polling if scan is running or pending
if (currentStatus === 'running' || currentStatus === 'pending') {
    startPolling();
}

// Stop polling when page is unloaded
window.addEventListener('beforeunload', stopPolling);
</script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-file-earmark-text"></i> Scan Details</h2>
    <div>
        <a href="{{ url_for('scans.list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to List
        </a>
    </div>
</div>

<div class="row">
    <!-- Scan Information -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Scan Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Scan ID:</strong> {{ scan.id }}
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        {% if scan.status == 'completed' %}
                            <span id="scan-status" class="badge bg-success">Completed</span>
                        {% elif scan.status == 'running' %}
                            <span id="scan-status" class="badge bg-primary">Running</span>
                        {% elif scan.status == 'failed' %}
                            <span id="scan-status" class="badge bg-danger">Failed</span>
                        {% else %}
                            <span id="scan-status" class="badge bg-secondary">{{ scan.status }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Target:</strong> <code>{{ scan.target }}</code>
                    </div>
                    <div class="col-md-6">
                        <strong>Scan Mode:</strong>
                        <span class="badge bg-{% if scan.scan_mode == 'active' %}warning{% else %}info{% endif %}">
                            {{ scan.scan_mode }}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Started:</strong> {{ scan.started_at.strftime('%Y-%m-%d %H:%M:%S') }}
                    </div>
                    <div class="col-md-6">
                        <strong>Completed:</strong>
                        <span id="completed-at">
                        {% if scan.completed_at %}
                            {{ scan.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% else %}
                            <span class="text-muted">N/A</span>
                        {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Duration:</strong> <span id="duration">{{ format_duration(scan.duration) }}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Parallel Execution:</strong>
                        {% if scan.parallel %}
                            <i class="bi bi-check-circle text-success"></i> Yes
                        {% else %}
                            <i class="bi bi-x-circle text-muted"></i> No
                        {% endif %}
                    </div>
                </div>
                
                {% if scan.plugins %}
                    <div class="mb-3">
                        <strong>Plugins:</strong>
                        <div class="mt-2">
                            {% for plugin in scan.plugin_list %}
                                <span class="badge bg-secondary me-1">{{ plugin }}</span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                {% if scan.output_dir %}
                    <div class="mb-3">
                        <strong>Output Directory:</strong>
                        <code class="d-block mt-1">{{ scan.output_dir }}</code>
                    </div>
                {% endif %}
                
                {% if scan.error_message %}
                    <div class="alert alert-danger mb-0">
                        <strong><i class="bi bi-exclamation-triangle"></i> Error:</strong>
                        <pre class="mb-0 mt-2">{{ scan.error_message }}</pre>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Plugin Results -->
        <div id="plugin-results-section" class="card shadow">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-puzzle"></i> Plugin Results</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Plugin</th>
                                <th>Status</th>
                                <th>Findings</th>
                                <th>Executed</th>
                            </tr>
                        </thead>
                        <tbody id="plugin-results-tbody">
                            {% for result in results %}
                                <tr>
                                    <td><strong>{{ result.plugin_name if result is mapping else result['plugin_name'] }}</strong></td>
                                    <td>
                                        {% set status = result.status if result is mapping else result['status'] %}
                                        {% if status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif status == 'in_progress' %}
                                            <span class="badge bg-primary">In Progress</span>
                                        {% elif status == 'pending' %}
                                            <span class="badge bg-secondary">Pending</span>
                                        {% elif status == 'success' %}
                                            <span class="badge bg-success">Success</span>
                                        {% elif status == 'fail' %}
                                            <span class="badge bg-danger">Failed</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set findings = result.findings_count if result is mapping else result['findings_count'] %}
                                        {% if findings > 0 %}
                                            <span class="badge bg-info">{{ findings }}</span>
                                        {% else %}
                                            <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set executed = result.executed_at if result is mapping else result['executed_at'] %}
                                        <small>{{ executed.strftime('%H:%M:%S') if executed else 'N/A' }}</small>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Sidebar -->
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Actions</h5>
            </div>
            <div class="card-body">
                {% if scan.status == 'completed' and report_path %}
                    <a href="{{ url_for('scans.view_report', scan_id=scan.id) }}" 
                       class="btn btn-success w-100 mb-2">
                        <i class="bi bi-file-earmark-text"></i> View Report
                    </a>
                    <a href="{{ url_for('scans.download_report', scan_id=scan.id) }}" 
                       class="btn btn-outline-success w-100 mb-2">
                        <i class="bi bi-download"></i> Download Report
                    </a>
                    <hr>
                {% endif %}
                
                <form method="POST" action="{{ url_for('scans.rerun', scan_id=scan.id) }}" 
                      onsubmit="return confirm('Re-run this scan with the same configuration?');">
                    <button type="submit" class="btn btn-info w-100 mb-2">
                        <i class="bi bi-arrow-clockwise"></i> Re-run Scan
                    </button>
                </form>
                
                <form method="POST" action="{{ url_for('scans.delete', scan_id=scan.id) }}" 
                      onsubmit="return confirm('Are you sure you want to delete this scan? This action cannot be undone.');">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-trash"></i> Delete Scan
                    </button>
                </form>
            </div>
        </div>

        <!-- Configuration -->
        <div class="card shadow">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-sliders"></i> Configuration</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0 small">
                    <li class="mb-2">
                        <strong>Verbose:</strong>
                        {% if scan.verbose %}
                            <i class="bi bi-check-circle text-success"></i> Enabled
                        {% else %}
                            <i class="bi bi-x-circle text-muted"></i> Disabled
                        {% endif %}
                    </li>
                    <li class="mb-2">
                        <strong>Dry Run:</strong>
                        {% if scan.dry_run %}
                            <i class="bi bi-check-circle text-success"></i> Yes
                        {% else %}
                            <i class="bi bi-x-circle text-muted"></i> No
                        {% endif %}
                    </li>
                    <li>
                        <strong>Parallel:</strong>
                        {% if scan.parallel %}
                            <i class="bi bi-check-circle text-success"></i> Yes
                        {% else %}
                            <i class="bi bi-x-circle text-muted"></i> No
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
