{% extends "base.html" %}

{% block title %}{{ profile.name }} - Configuration Profile - KAST-Web{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('config_profiles.list_profiles') }}">Configuration Profiles</a></li>
                    <li class="breadcrumb-item active">{{ profile.name }}</li>
                </ol>
            </nav>
            <h1>
                <i class="fas fa-sliders-h"></i> {{ profile.name }}
                {% if profile.is_system_default %}
                <span class="badge bg-primary">Default</span>
                {% endif %}
            </h1>
        </div>
        {% if current_user.is_power_user or current_user.is_admin %}
        <div class="col-md-4 text-end">
            <div class="btn-group">
                <a href="{{ url_for('config_profiles.edit_profile', profile_id=profile.id) }}" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Edit
                </a>
                <button type="button" class="btn btn-info" onclick="duplicateProfile()">
                    <i class="fas fa-copy"></i> Duplicate
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteProfile()">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Profile Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Name:</dt>
                        <dd class="col-sm-9">{{ profile.name }}</dd>

                        <dt class="col-sm-3">Description:</dt>
                        <dd class="col-sm-9">{{ profile.description or 'No description provided' }}</dd>

                        <dt class="col-sm-3">Created By:</dt>
                        <dd class="col-sm-9">{{ profile.creator.username }}</dd>

                        <dt class="col-sm-3">Created At:</dt>
                        <dd class="col-sm-9">{{ profile.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</dd>

                        {% if profile.updated_at %}
                        <dt class="col-sm-3">Last Updated:</dt>
                        <dd class="col-sm-9">{{ profile.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</dd>
                        {% endif %}

                        <dt class="col-sm-3">System Default:</dt>
                        <dd class="col-sm-9">
                            {% if profile.is_system_default %}
                            <span class="badge bg-success">Yes</span>
                            {% else %}
                            <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Standard Users:</dt>
                        <dd class="col-sm-9">
                            {% if profile.allow_standard_users %}
                            <span class="badge bg-success">Allowed</span>
                            {% else %}
                            <span class="badge bg-warning text-dark">Power Users Only</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Usage:</dt>
                        <dd class="col-sm-9">Used in {{ profile.scans.count() }} scan(s)</dd>
                    </dl>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-code"></i> Configuration (YAML)</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                <div class="card-body">
                    <pre id="yaml-content" class="bg-light p-3 border rounded" style="max-height: 600px; overflow-y: auto;"><code>{{ profile.config_yaml }}</code></pre>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            {% if config_json %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-brackets-curly"></i> Parsed Structure (JSON)</h5>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 border rounded" style="max-height: 400px; overflow-y: auto;"><code>{{ config_json }}</code></pre>
                </div>
            </div>
            {% endif %}

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-question-circle"></i> Quick Reference</h5>
                </div>
                <div class="card-body">
                    <p class="small">To use this profile when running a scan:</p>
                    <ol class="small">
                        <li>Go to <a href="{{ url_for('main.index') }}">New Scan</a></li>
                        <li>Select "{{ profile.name }}" from the Configuration Profile dropdown</li>
                        <li>Configure your scan target and plugins</li>
                        <li>Run the scan</li>
                    </ol>
                    <hr>
                    <p class="small mb-0"><strong>CLI Usage:</strong></p>
                    <pre class="small bg-light p-2 border rounded"><code>kast --config {{ profile.name|lower|replace(' ', '_') }}.yaml example.com</code></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<form method="POST" action="{{ url_for('config_profiles.delete_profile', profile_id=profile.id) }}" id="deleteForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

<!-- Duplicate Form -->
<form method="POST" action="{{ url_for('config_profiles.duplicate_profile', profile_id=profile.id) }}" id="duplicateForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

<script>
function copyToClipboard() {
    const yamlContent = document.getElementById('yaml-content').textContent;
    navigator.clipboard.writeText(yamlContent).then(() => {
        alert('Configuration copied to clipboard!');
    });
}

function deleteProfile() {
    if (confirm('Are you sure you want to delete this configuration profile?\n\nThis action cannot be undone.{% if profile.scans.count() > 0 %}\n\nNote: This profile is currently used by {{ profile.scans.count() }} scan(s) and cannot be deleted.{% endif %}')) {
        document.getElementById('deleteForm').submit();
    }
}

function duplicateProfile() {
    if (confirm('Create a duplicate of this profile?\n\nYou will be redirected to edit the new copy.')) {
        document.getElementById('duplicateForm').submit();
    }
}
</script>
{% endblock %}
